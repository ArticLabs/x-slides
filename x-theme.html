<link rel="import" href="../polymer/polymer.html">

<dom-module id="x-theme">
  <script>
    (() => {
      let _themes = new Map();

      window.XTheme = Polymer({
        is: 'x-theme',

        properties: {
          name: {
            type: String,
            observer: '_nameChanged',
          },
        },

        _nameChanged(newName, oldName) {
          if (oldName && _themes.has(oldName) && _themes.get(oldName) === this) {
            _themes.delete(oldName);
          }
          if (newName) {
            _themes.set(newName, this);
          }
        },

        prepareSlideTemplate(template, layout) {

          let themeTemplate = this.getLayout(layout);
          if (themeTemplate) {
            template = _processTemplate(template, themeTemplate);
          }
          return template;
        },

        getLayout(layout) {
          let template = Polymer.dom(this).querySelector(`template[name=${layout}]`);
          if (!template) {
            console.warn('no layout', layout);
          }
          if (!template._preparedTemplate) {
            let _extends = template.getAttribute('extends');
            console.log('layout', layout, 'entends', _extends);
            if (_extends) {
              let superTemplate = this.getLayout(_extends);
              template._preparedTemplate = _processTemplate(template, superTemplate);
            } else {
              template._preparedTemplate = template;
            }
          }
          return template._preparedTemplate;
        },

      });

      window.XTheme.getTheme = function(name) {
        return _themes.get(name);
      };

      function _processTemplate(template, superTemplate) {
        // find the block into which the super template should be placed.
        var superBlock =
          template.content.querySelector('template[block=super]');
        // there's a super template and a block in which to put it so
        // perform super composition!
        if (superBlock && superTemplate) {
          // set flag for later use in style composition
          // this.__usesSuperTemplate = true;
          // Copy the super template and remove styles since we'll compose those
          // separately.
          superTemplate = superTemplate.cloneNode(true);
          superTemplate.setAttribute('block', '');
          // this.removeStyles(superTemplate.content);
          // mix the super block into the super template and replace the super
          // block.
          _composeTemplate(superTemplate, superBlock);
          superBlock.parentNode.replaceChild(superTemplate, superBlock);
          console.log('composed super', superTemplate);
        }
        // copy the working template and store it as the sub-classable template.
        let _subTemplate = template.cloneNode(true);
        console.log('subTemplate', _subTemplate);
        // extract fallback content into our working template
        _composeTemplate(template);
        return template;
      }

      // if we use our super template, our styles concat to our super's.
      function _collectStyles() {
        var superStyles = [];
        var styles = superStyles.concat(Polymer.Base._collectStyles.call(this));
        removeStyleRules(styles);
        return styles;
      }

      function _composeTemplate(target, source) {
        var slots = target.content.querySelectorAll('template[block]');
        for (var i=0; i < slots.length; i++) {
          var n = slots[i];
          var sel = n.getAttribute('block');
          var r = source && sel &&
            source.content.querySelector('template[block=' + sel + ']');
          if (r) {
            n.parentNode.replaceChild(r.content.cloneNode(true), n);
          } else {
            n.parentNode.replaceChild(n.content, n);
          }
        }
      }

      function removeStyles(element) {
        var s$ = element.querySelectorAll('style');
        for (var i=0, e; i < s$.length; i++) {
          e = s$[i];
          e = e.__appliedElement || e;
          e.parentNode.removeChild(e);
        }
      }

      function removeStyleRules(styles) {
        for (var i=0; i < styles.length; i++) {
          styles[i].__cssRules = null;
        }
      }

    })();
  </script>
</dom-module>
